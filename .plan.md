# Performance Optimization Plan: SAM-3D Pipeline

## Overview

현재 SAM-3D 파이프라인 성능:
- 객체당 평균: **5.12초**
- 목표: **2.5초 이하** (50% 개선)

## 최적화 전략

### Phase 1: 이미지 다운샘플링 (High Impact)

SAM-3D 내부에서 518x518로 리사이즈하므로, 큰 이미지를 미리 축소하면 전처리 시간 절약

| max_size | 예상 속도 향상 | 품질 영향 |
|----------|---------------|-----------|
| 768 | 10-15% | 없음 |
| 512 | 20-30% | 최소 |
| 384 | 30-40% | 약간 |

**파일**: `ai/subprocess/persistent_3d_worker.py`

### Phase 2: Inference Steps 최적화 (Medium-High Impact)

Stage 2 inference steps 감소 (현재 기본값: 12)

| stage2_inference_steps | 예상 속도 향상 | 품질 영향 |
|------------------------|---------------|-----------|
| 8 | 15-25% | 최소 |
| 6 | 25-35% | 약간 |
| 4 | 40-50% | 눈에 띔 |

**파일**: `ai/subprocess/persistent_3d_worker.py`

### Phase 3: PLY 후처리 최적화 (Medium Impact)

ASCII PLY → Binary PLY 전환
- 파일 크기: ~70% 감소
- 후처리 시간: ~50% 감소

**파일**: `ai/subprocess/persistent_3d_worker.py`

### Phase 4: decode_formats 최소화 (Low Impact)

부피 계산만 필요하면 GLB 생성 스킵
- `["gaussian", "glb", "mesh"]` → `["gaussian"]`
- 예상: 5-10% 속도 향상

## 예상 총 성능 향상

| 조합 | 예상 개선 |
|------|----------|
| Phase 1 (512) + Phase 2 (8) | 35-50% |
| Phase 1 (512) + Phase 2 (6) + Phase 4 | 50-70% |

## 구현 우선순위

1. **즉시 적용**: 이미지 다운샘플링 (max_size=512)
2. **즉시 적용**: stage2_inference_steps=8
3. **테스트 후**: Binary PLY
4. **옵션**: decode_formats 최소화

## Success Criteria

- [ ] 객체당 평균 2.5초 이하
- [ ] 부피 계산 오차 5% 이내
- [ ] 기존 API 호환성 유지

---

## Implementation Status (2026-01-22)

### Completed Changes

All optimizations have been implemented in `ai/subprocess/persistent_3d_worker.py`:

#### Module-Level Configuration Constants (Lines 51-64)
```python
MAX_IMAGE_SIZE = 512           # Phase 1: Image downsampling
STAGE2_INFERENCE_STEPS = 8     # Phase 2: Inference steps
USE_BINARY_PLY = True          # Phase 3: Binary PLY format
```

#### Phase 1: Image Downsampling
- Added `downsample_image_and_mask()` function (lines 86-122)
- Applies before SAM-3D processing
- Uses LANCZOS for image, NEAREST for mask (preserves binary values)

#### Phase 2: Inference Steps
- Added `stage2_inference_steps=STAGE2_INFERENCE_STEPS` to `pipe.run()` (line 432)
- Default: 8 steps (vs original 12)

#### Phase 3: Binary PLY
- Updated `add_rgb_to_ply()` with `use_binary` parameter (lines 146-232)
- Uses structured numpy array for efficient binary output
- ~70% smaller files, ~50% faster write time

#### Phase 4: decode_formats (Optional)
- Added `volume_only` parameter to `TaskMessage` in `worker_protocol.py`
- When `volume_only=True`, uses `["gaussian"]` only (skips GLB/mesh)

### Files Modified
1. `ai/subprocess/persistent_3d_worker.py` - Main optimizations
2. `ai/subprocess/worker_protocol.py` - Added `volume_only` parameter

### Testing Required
```bash
# Run E2E test with timing comparison
python test_e2e_full_pipeline.py

# Expected results:
# - Before: ~5.12s per object
# - After: ~2.5s per object (50% improvement target)
```
